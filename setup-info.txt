
Simple html/css, python, flask and jinja2 examples run on local machine

####################
General Flask information:
Micro framework, doesn't do much, allows us to receive user data and send
data back as per user requests. Because it doesn't do that much for us, we
can write our applications in pure python, it doesn't tell us how we should
be writing our code.

# Installing flask on windows / powershell terminal (within vscode)
(01) Install python 3

(02) Create a virtual environment (pyenv) Pyenv for windows: https://github.com/pyenv-win/pyenv-win

    # Powershell install pyenv:
    Invoke-WebRequest -UseBasicParsing -Uri "https://raw.githubusercontent.com/pyenv-win/pyenv-win/master/pyenv-win/install-pyenv-win.ps1" -OutFile "./install-pyenv-win.ps1"; &"./install-pyenv-win.ps1"
    # restart Powershell
    pyenv --version
    
    # How to use pyenv (same commands apply to pyenv for windows)
    # https://blog.teclado.com/how-to-use-pyenv-manage-python-versions/

    # Quickstart
    PS:> echo "flask`npython-dotenv" > requirements.txt
    pyenv exec python -m venv .venv 
    .\.venv\Scripts\activate
    pip install -r requirements.txt
    flask run
    
    # Teclado microblog code uses python 3.9.0
    pyenv install --list
    pyenv versions
    pyenv install 3.9.0
    pyenv versions
    pyenv local 3.9.0
    pyenv local
    # create a virtual environment (intellisence can now work)
    pyenv exec python -m venv .venv 
    (add .venv to gitignore)
    (if vscode asks if you want to select the new environment for 
    the workspace folder, select yes)
    # activate the virtual environment

(03) Activate pyenv
    .\.venv\Scripts\activate

(04) Install Flask (into the virtual environment)
    pip install Flask

(05) Install dotenv for environment variable management 
    pip install python-dotenv

(06) Set flask environment variables (powershell)
    # Tell Flask before we run it which python file contains the Flask app
    $env:FLASK_APP="app.py"
    $env:FLASK_APP
    $env:FLASK_DEBUG=1
    $env:FLASK_DEBUG
        #$env:FLASK_ENV=development (using FLASK_DEBUG instead)
        #$env:FLASK_ENV

    FLASK_RUN_HOST="127.0.0.1"
    FLASK_RUN_HOST
    FLASK_RUN_PORT=5500 # live server defaults to this
    FLASK_RUN_PORT

    Put secret info into .env (eg: MongoDB Atlas passwd). Don't put .env into git.
    Put flask environment variables into .flaskenv. Do put .flaskenv into git.
    load_dotenv loads info from both .env and .flaskenv when it is run.

Environment variables are deleted by setting them to null:
$env:TEST_VAR = 1 (create and set to 1)
$env:TEST_VAR = $null (delete)

(07) Write Flask app in file app.py (default for Flask)

    from flask import Flask
    from dotenv import load_dotenv
    load_dotenv()
    app = Flask(__name__)
    @app.route("/")
    def hello_world():
        return "Hello, world!"

(08) Now we can run flask
    flask run

(09) MongoDB / Cloud Atlas / pymongo
    pip install pymongo[srv] # in pyenv 3.9.0  
    See Mongo Cloud Atlas setup notes below
    My username is js77 for MongoDB Atlas
    VPN: need to add vpn address to Network Access in Cloud
    Atlas or will get pymongo connection timeout errors

(10) Deploy to render.com
    1. pip freeze (to see dependencies our app needs)
    2. add all these to "requirements.txt" (copy / paste)
       Can add only the following rather than everything from "pip freeze",
       these'll install the dependencies shown in "pip freeze" too (but the
       latest versions, not specific versions as in the "pip freeze" list)
            Flask
            pymongo[srv]
            python-dotenv
            gunicorn
       We'll install these via "pip install -r requirements.txt" when setting up render.com     
    3. also need to add gunicorn to "requirements.txt"
    4. put code on Github, can be public or private repo, doesn't matter
    5. Connect to Github account
    6. open New -> Web Service on render.com
    7. Choose Github code then deploy the web service:
        - Give web service a name, this will form the URL
        - Choose region closest to me
        - Select the Github branch to use
        - Root Directory: empty
        - Runtime: Python 3
        - Build command: pip install -r requirements.txt
        - Start command: gunicorn "app:create_app()"
            ...(I was using "flask run" before)
        - Auto deploy on (500 build mins per month should be enough)
        - Select free webservices plan
        - Advanced: Add environment variables
            MONGODB_URI with username and passwd (what's in our local (gitignored) .env file)
            PYTHON_VERSION 3.11.3 (latest version of python)
        - On MongoDB Atlas (js77) add Netwrok Access for render.com
            Click Connect -> Outbound tab, copy the 3 URLs to the allow network access on MongoDB
            Atlas, copy one at a time.
            USABILITY: allow access from everywhere on Atlas (don't restrict IPs)
            [[  
                - Wrong!
                    USABILITY: have the password for Atlas in the code (app.py), not a .env URI
                    ("Preparing our app for deployment"), this means anyone can access my Atlas
                    DB via the user mong-atlas. 
            ]]
            [[ 
                - Correct!
                    USABILITY: All visitors to my render.com flask app website will access the
                    same Atlas db. The password can be visible in the code (not recommended) or
                    setup as a MONGODB_URI environment variable on render.com (recommended).
            ]]
            USABILITY: Summary: (1) Allow access from anywhere on my MongoDB Atlas DB.
                                (2) Don't put the Atlas DB password in the code, hide it
                                    - Hide via .env MONGODB_URL in the code (.env file gitignored)
                                    - Put the MONGODB_URI into a render.com environment variable when deploying
            
            Teclado Bots:   "There are bots that search public gitub repos for mongodb usernames and passwords"!
                            Remember, they will show in the history even if not in the final code.

                            He use jose [at] email.com so  a little harder for bots to scrape and subscribe you
                            to email lists.
                
        - Now click Create Web Service button at the bottom of the page and wait for it to live.

        - Need to add payment info / credit card FIRST AND THEN I can use the paid instance type options. These
          paid instance types don't have spin down.


    8. Dashboard -> Settings -> Can rename Web Service or delete Web Service here.
        Note that renaming the Web Service doesn't change the URL for the site,
        only changes the name of the Web Service on render.com dashboard 

    9. Different PaaSes (Platforms as a Service):
        Render: Spun-down on free plans, after 15 mins, goes to sleep.
        $7pcm for plan that doesn't spin down. Need to add credit card to site first to be able to select this
        starter instance type plan. 
        
        Heroku Basic plan, $7 pcm Basic Plan never sleep.
        "Trick" heroku by including one tiny dynamic page if want static site.
        pythonanywhere, $5pcm for Hacker plan that never sleeps, 1 web app
        pythonanywhere, $12pcm for Web Dev plan that never sleeps, 2 web apps
    
    10. Render STATIC site hosting (easy to do):
        Select New->Static site.
        Name: sif-example
        Branch: main
        Root Directory: "leave blank"
        Build Command: "leave blank"
        Publish Directory: ./
        Create Static Site->Click

    11. Deploy to Heroku Info:
        - needs file "requirements.txt" (contains four lines:
                                            flask
                                            pymongo[srv]
                                            python-dotenv
                                            gunicorn
                                        )
        - needs file "runtime.txt", contains the python version, ie: single line of-> python-3.9.0 
        - needs file "Procfile", with a single line of->  web: gunicorn "app:create_app()"   
        - Github used to get code, deployment method, can be public or private code, both fine with Heroku
        - Heroku site: Deploy tab and More-tab-ViewLogs the two most important tabs on the site
        - Heroku site: calls Web Services / servers "dynos"
        - Heroku site: Settings - Config Vars (environment variables, configure: MONGODB_URI)
        - Heroku site: Deploy tab - Manual deploy

        - Adding a payment card will you to select the non-free (non-sleeping) dynos / web services.

(11)    "black" and "flake8" he installed too (formatter and linter). 
        The "jinja" extension performs language colorization for jinja
        



####################
Content that is static doesn't have to be generated, modified or processed.
The server just delivers the file to the user and the user uses it, it doesn't
have to go through any processing by the user.

In flask, HTML files go into a folder called "templates/" and this folder should
be in the same directory as the "app.py" file. The directory should be the the
top dir of the project - this is what Flask expects and looks for. For example,
"first_page.html" and  "second_page.html" can go in "templates/".

Also need to import "render_template" in app.py as this allows naming a file to
be sent to the user.

In "app.py", the function names are largely irrelevant. What the user interacts with
are the endpoints (@app.route("/"), etc). Function names only useful for out
application itself, the user doesn't care about them.

####################
Jinja2, library that comes installed with Flask.
Allows us to interpolate, to put stuff (other strings) into a text - these
other strings are HTML strings.
A template is any string of text that contains placeholders for the template
language to be able to replace these placeholders with something else.
The syntax used for the placeholders, and the whole syntax of the template
as a whole, is known as a template language, and the underlying code that
evaluates the template and puts the new values in is called a template
engine.
Flask comes with the powerful Jinja2 template language.
Flask and Jinja2 were written by the same person.

####################
Jinja2
Interpolate: "to insert between other elements or parts" 
{{ }}   expressions, these will get reduced to a single value and
        get interpolated into the template
{% %}   statements, allow Jinja2 tp make decisions or do something
        other than interpolating values (if, for)

####################
Final Forward Slashe in @app.route endpoints.
Endpoint of: @app.route("/home/") is better to use than:
@app.route("/home") because typing URL of
https://www.example.com/home or https://www.example.com/home/
will take you to the expected page. 

Endpoint of: @app.route("/home") would result in only
https://www.example.com/home working with 
https://www.example.com/home/ failing.

Teclado website 18k hits per month, most ever simultaneous POSTS is 5


####################
MongoDB Cloud Atlas
My username is js77 for MongoDB Cloud Atlas
MongoDB originally designed for large amounts of small pieces data
**MongoDB Cloud Atlas (DB in the cloud, DBaaS, DB as a Service)
**MongoDB Compass (local GUI for managing our DBs in the cloud)
MongoDB Collections of Documents (CD)

No schema needed in mDB so easy to store a lot of info without
lots of design considerations (unlike schema based SQL) but
this also means you cannot do joins to see relationships between
tables / do multiple checks like SQL cam
SQL creates relations between tables via PKs and FKs

{JSON} = 1 document
[{JSON1}, {JSON2}] = multiple documents (list of documents)

A mDB document is "like" a row in a SQL table. A collection
of documents is "like" a SQL table

** pip install pymongo[srv] # in pyenv 3.9.0  
# srv part need to connect to cloud atlas

pip freeze # see everything you've installed with pip
mongodb+srv://mong-rabbit:<password>@jack-rabbit.u44ibnh.mongodb.net/
Replace all of <password> with the password (remove < > too)

"jack-rabbit" is a mongoDB atlas CLUSTER
via USER "mong-rabbit" & PASSWD ****.
An atlas cluster can be though of as a cloud server
User "mong-rabbit" was created on the cloud atlas website

Atlas Website access for all to use my MongoDB cluster. 
1. No IP restrictions
2. Passwd for mong-rabbit user in the python code (can change later)
Faster as well in ad hoc tests when no VPN used and allow access to all IPs.
To allow access from anywhere:
All Clusters -> jack-rabbit -> Network access -> +Add IP Address -> Allow Access from Anywhere
To Change password!
All Clusters -> jack-rabbit -> Database access -> mong-rabbit (user)-> Edit


####################
Environment (in pyenv)
pip install python-dotenv
